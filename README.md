# Guided DDPM

This repository demonstrates how to deploy a DDPM (Denoising Diffusion Probabilistic Model) on Google Cloud using a containerized Flask application. Given a user-uploaded selfie, the model generates celebrity faces that resemble the input image. The model is served through a backend and can be accessed via a web front-end hosted on GCP Cloud Run.

## Overview

- **Model**: Based on Hugging Face's `diffusers` library ([link to repo](https://github.com/huggingface/diffusers)).
- **Training Data**: 30,000 high-quality celebrity faces, resized to 256x256 pixels.
- **Output**: Celebrity face images generated to resemble the uploaded selfie using guided DDPM inference.

## Local Development & Testing

You can run the app locally using Docker or a Python virtual environment.

### Using Docker

#### Build the image:
```bash
cd /path/to/project-root
docker build -t flask-app .
```
Run the container (GPU-enabled):
```bash
docker run --gpus all -p 5000:8080 -v $(pwd):/app -e PORT=8080 flask-app
```
> **Note**: Ensure that your system has NVIDIA drivers and the NVIDIA Container Toolkit installed to enable GPU support.

### Using Python Virtual Environment
```bash
python -m venv venv
source venv/bin/activate  # or `venv\Scripts\activate` on Windows
pip install -r requirements.txt 
```
Run the Flask app:
```bash
python main.py
```
## GCP Deployment
Youâ€™ll need:

- A Google Cloud account
- The gcloud CLI installed and authenticated

Setup
Set your GCP region:
```bash
gcloud config set run/region europe-west1
```
Create a Docker Artifact Repository:
```bash
gcloud run deploy guided-ddpm-service \
  --image=europe-west4-docker.pkg.dev/guided-ddpm/docker-repo/guided-ddpm:v0 \
  --region=europe-west1 \
  --cpu=4 \
  --memory=16Gi \
  --port=8080
```
Build and push your image:

```bash
gcloud builds submit --tag europe-west4-docker.pkg.dev/guided-ddpm/docker-repo/guided-ddpm:v0
```
Deploy to Cloud Run:
```bash
gcloud run deploy guided-ddpm-service \
  --image=europe-west4-docker.pkg.dev/guided-ddpm/docker-repo/guided-ddpm:v0 \
  --region=europe-west1 \
  --cpu=4 \
  --memory=16Gi \
  --port=8080
```
## Model Testing & Examples

Below are example generated images without guidance:

<img src="generated_images/generated_image_0.png" alt="Generated Image Example 0" width="150">
<img src="generated_images/generated_image_1.png" alt="Generated Image Example 1" width="150">
<img src="generated_images/generated_image_2.png" alt="Generated Image Example 2" width="150">
<img src="generated_images/generated_image_4.png" alt="Generated Image Example 2" width="150">

Here are some example outputs generated by the model :

### In-Distribution Data
The model performs well on in-distribution data, producing high-quality results:  
<img src="generated_images/id_gen.png" alt="Generated Images - In-Distribution" width="600">

### Human Selfie
Using a selfie as input, the model generates celebrity-like faces resembling the target:  
<img src="generated_images/selfie_gen.png" alt="Generated Images - Selfie" width="600">

### Non-Human Inputs
The model also attempts to generate outputs for non-human inputs:

**Dog Image**:  
<img src="generated_images/dog_gen.png" alt="Generated Images - Dog" width="600">

**Cat Image**:  
<img src="generated_images/cat_gen.png" alt="Generated Images - Cat" width="600">
